# 前端版本控制系统 (Frontend Version Control) - 验证逻辑与核心流程

本项目演示了“不可变产物”与“后端控制渲染”的完整流程。以下是核心验证逻辑。

## 1. 核心概念

- **Manifest (清单)**: 每次前端构建都会生成 `manifest.json`，记录 `src/index.html` 对应 `dist/assets/index.[hash].js` 的映射关系。
- **Immutable Artifacts (不可变产物)**: 发布的 `artifacts/v1.0.0` 目录一旦存在，发布脚本会报错，禁止覆盖。
- **Runtime Injection (运行时注入)**: 后端不托管静态 HTML 文件，而是读取 HTML 模板，并在**请求时 (Request Time)** 根据当前版本配置动态拼接 JS/CSS 路径。

## 2. 验证流程 (Verification Logic)

### Step 1: 环境准备

确保 Node.js 20+ 已安装。

```bash
# 根目录下安装依赖
pnpm install
```

### Step 2: 启动后端 (运行时)

后端服务默认监听 3000 端口，并挂载 `artifacts/` 目录为静态资源。

```bash
cd apps/backend
pnpm build
pnpm start
# 保持此终端开启，或者在后台运行
```

### Step 3: 发布 Version 1 (构建与上传)

模拟前端团队发布 v1.0.0 版本。

```bash
# 新开终端
cd apps/frontend
# 此命令会: 
# 1. 运行 vite build 
# 2. 检查 artifacts/v1.0.0 是否存在
# 3. 将 dist/ 移动到 artifacts/v1.0.0
pnpm publish:v1
```

**验证点**:
- 检查项目根目录 `artifacts/v1.0.0/.vite/manifest.json` 是否存在。
- 访问 `http://localhost:3000/`，查看源代码，确认引入的 JS/CSS 路径包含 `/artifacts/v1.0.0/...`。
- 页面应显示 React 默认界面。

### Step 4: 发布 Version 2 (模拟迭代)

在不停止后端服务的情况下，模拟发布新版本。
为了效果明显，你可以先修改 `apps/frontend/src/App.tsx` 中的文字（例如加上 "V2 Update"）。

```bash
cd apps/frontend
pnpm publish:v3
```

**验证点**:
- 此时 `artifacts/v1.0.1` 目录已创建。
- 刷新浏览器，**页面内容不变**（因为后端仍指向 v1.0.0）。这是为了证明发布过程是安全的，不会自动影响线上用户。

### Step 5: 版本热切换 (Traffic Switch)

通过 Admin API 瞬间切换所有流量到新版本。

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"version": "v1.0.1"}' \
  http://localhost:3000/api/admin/version
```

**验证点**:
- 终端显示切换成功。
- 刷新浏览器，页面内容**立刻**变为 v2 (包含你修改的文字)。
- 查看网页源代码，引用路径已变为 `/artifacts/v1.0.1/...`。

### Step 6: 瞬间回滚 (Rollback)

如果 v2 有 Bug，立刻切回 v1。

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"version": "v1.0.0"}' \
  http://localhost:3000/api/admin/version
```

**验证点**:
- 刷新浏览器，页面立刻恢复为 v1。无需重新构建，无需重新部署后端。

## 3. 核心代码文件说明

- **`scripts/publish.ts`**: 用于前端发布的脚本，包含不可变性检查（如果目录存在则报错）。
- **`apps/backend/src/services/VersionService.ts`**: 负责解析 Manifest JSON，找到入口文件，并管理当前生效版本。
- **`apps/backend/src/app.ts`**: Express 应用入口，包含 HTML 模板的字符串替换逻辑 (`replace` `<!-- INJECT_... -->`)。
